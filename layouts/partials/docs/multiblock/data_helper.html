{{/* Given an ID mapping, processes the data for the multiblock/render partial to use.  */}}

{{- $data := slice -}}
{{- if and (and .pattern (reflect.IsSlice .pattern)) (and .mapping (reflect.IsMap .mapping)) -}}
  {{- $max_y := 0 -}}
  {{- $max_z := 0 -}}
  {{- range .pattern -}}
    {{- if not (reflect.IsSlice .) -}}
      {{- errorf "Improper multiblock pattern on page %v! X-plane is not array." $.Page -}}
    {{- end -}}
    
    {{- if lt $max_y (len .) -}}
      {{- $max_y = (len .) -}}
    {{- end -}}
    
    {{- $x_plane := slice -}}
    
    {{- range . -}}      
      {{- if lt $max_z (len .) -}}
        {{- $max_z = (len .) -}}
      {{- end -}}
      
      {{- $z_row := slice -}}
      {{- range split . "" -}}
        {{- if lt $max_z (len .) -}}
          {{- $max_z = (len .) -}}
        {{- end -}}
        {{$ids := index $.mapping .}}
        {{- if reflect.IsSlice $ids -}}
          {{- $z_row = $z_row | append (slice $ids) -}}
        {{- else if index $.mapping . -}}
          {{- $z_row = $z_row | append $ids -}}
        {{- else -}}
          {{- $z_row = $z_row | append "" -}}
        {{- end -}}
      {{- end -}}
      {{- $x_plane = $x_plane | append (slice $z_row) -}}
    {{- end -}}
    
    {{- $data = $data | append (slice $x_plane) -}}
  {{- end -}}
  {{- $dimensions := slice (len .pattern) $max_y $max_z -}}
{{- else -}}
  {{- errorf "Either no mapping or no pattern supplied for multiblock data processing on page $v." .Page -}}
{{- end -}}
{{- return $data -}}