{{/* Given a multiblock pattern and mapping, renders a multiblock structure. */}}

{{- $sprite_size := 32 -}}
{{- $xz_horz := 0.4423 -}}
{{- $xz_vert := 0.2210 -}}
{{- $y_vert := -0.5414 -}}

{{/* Per block horiz/vertical offsets in the order x-y-z. */}}
{{- $offset_map := slice (slice (mul (math.Round (mul $xz_horz $sprite_size)) -1) 0 (math.Round (mul $xz_horz $sprite_size))) 
(slice (math.Round (mul $xz_vert $sprite_size)) (math.Round (mul $y_vert $sprite_size)) (math.Round (mul $xz_vert $sprite_size))) -}}

{{- if and .mapping (reflect.IsMap .mapping) -}}
  {{- $dimensions := .dimensions -}}
  {{- if not (reflect.IsSlice $dimensions) -}}
    {{- $dimensions = partial "docs/multiblock/dimensions" (dict "Page" .Page "pattern" .pattern) -}}
  {{- end -}}
  
  {{- $offset := slice (mul (index (index $offset_map 0) 2) (index $dimensions 2))
    (mul (mul (index (index $offset_map 1) 1) (index $dimensions 1)) -1) -}}
  
  {{- $padding := 28 -}}
  {{- $width := add $padding (sub (index $offset 0) (mul (index (index $offset_map 0) 0) (index $dimensions 0))) -}}
  {{- $height := add (add $padding (index $offset 1)) (add (mul (index (index $offset_map 1) 0) (index $dimensions 0)) (mul (index (index $offset_map 1) 2) (index $dimensions 2))) -}}
  
  <div class="multiblock-display" style="width:{{$width}}px; height:{{$height}}px;">
    {{- range $x, $x_planes := .pattern -}}
      {{- range $y, $z_rows := . -}}
        {{- range $z, $key := split . "" -}}
          {{- $ids := index $.mapping $key }}
          {{- if $ids -}}
            {{- $coords := slice $x $y $z -}}
            {{- $pos := slice -}}
            {{- range seq 0 1 -}}
              {{- $multipliers := index $offset_map . -}}
              {{- $pixels := index $offset . -}}
              {{- range seq 0 2 -}}
                {{- $pixels = add $pixels (mul (index $multipliers .) (index $coords .)) -}}
              {{- end -}}
              {{- $pos = $pos | append $pixels -}}
            {{- end -}}
            {{- $style := printf "position:absolute; left:%vpx; top:%vpx;" (index $pos 0) (index $pos 1) -}}
            <div class="multiblock-block" data-layer={{$y}} style="{{safeCSS $style}}">
              {{- partialCached "docs/icon" (dict "Page" $.Page "version" $.version "ids" $ids) $ids $.version -}}
            </div>
          {{- end -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  </div>
{{- else -}}
  {{- errorf "Improper multiblock input on page %v! Check your mapping." .Page -}}
{{- end -}}